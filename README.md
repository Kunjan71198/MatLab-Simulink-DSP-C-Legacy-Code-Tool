# MatLab-Simulink DSP C-Legacy-Code-Tool

This work presents the methods used in MatLab scripts to design linear systems and its block generation for simulink with Legacy code tool.

Automated generation of filter coefficient header file. The next MATLAB script receives parameter designs and generates DPS.H containing the filter coefficients used for the DSP software implementation.
```MATLAB
unction Butterworth_POXI(fh, Lowpass_Order, fl, Highpass_Order, T)
% Butterworth IIR filter design.
%
% fh             = Low pass cut-off frecuency
% Lowpass_Order  = Low pass filter order
% fl             = High pass cut-off frecuency
% Highpass_Order = Low pass filter order
% T              = Sample time

if nargin ~= 5
    error('We need five arguments !');
end

disp('Poxi filter design ...')
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
format long
F = 1/T;

[BH,AH]=butter(Highpass_Order,fl/(F/2),'high');
[BL,AL]=butter(Lowpass_Order,fh/(F/2),'low');

disp('Generating "..\poxi.sdk\poxi\src\dsp\DSP.H" ...')
file = fopen('..\poxi.sdk\poxi\src\dsp\DSP.H', 'w');
fprintf(file, '/*****************************************************************************/\n');
fprintf(file, '/**                                                                         **/\n');
fprintf(file, '/** DSP.H                                                                   **/\n');
fprintf(file, '/**                                                                         **/\n');
fprintf(file, '/** Butterworth IIR filter design.                                          **/\n');
fprintf(file, '/** This file was auto generated by a MATLAB script.                        **/\n');
fprintf(file, '/**                                                                         **/\n');
fprintf(file, '/** Created on: %s                                                 **/\n', date());
fprintf(file, '/**                                                                         **/\n');
fprintf(file, '/** Author: Yarib Nevárez                                                   **/\n');
fprintf(file, '/**         yarib_007@hotmail.com                                           **/\n');
fprintf(file, '/**                                                                         **/\n');
fprintf(file, '/*****************************************************************************/\n');
fprintf(file, '\n#ifndef DSP_H_');
fprintf(file, '\n#define DSP_H_');
fprintf(file, '\n/*****************************************************************************/\n');
fprintf(file, '#define DSP_SAMPLE_TIME           %.16f', T);
fprintf(file, '\n/*****************************************************************************/\n\n');
fprintf(file, '#define HIGH_PASS_CUTOFF_FREC_HZ  %.2f \n', fl);
fprintf(file, '#define HIGH_PASS_FILTER_ORDER    %d \n\n', Highpass_Order);

for x = 1:length(AH)
    fprintf(file, '#define F0_A%d  ((const double)%.16d)\n', x-1, AH(x));
end

fprintf(file, '\n');
for x = 1:length(BH)
    fprintf(file, '#define F0_B%d  ((const double)%.16d)\n', x-1, BH(x));
end

fprintf(file, '\nconst double A_high_pass [] = {');
for x = 1:(length(AH)-1)
    fprintf(file, 'F0_A%d, ', x-1);
end
fprintf(file, 'F0_A%d};',x);

fprintf(file, '\nconst double B_high_pass [] = {');
for x = 1:(length(BH)-1)
    fprintf(file, 'F0_B%d, ', x-1);
end
fprintf(file, 'F0_B%d};',x);

fprintf(file, '\nconst FilterParameters high_pass_filter_parameters = {HIGH_PASS_FILTER_ORDER, A_high_pass, B_high_pass};');
fprintf(file, '\n\n/*****************************************************************************/\n');
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fprintf(file, '\n');
fprintf(file, '#define LOW_PASS_CUTOFF_FREC_HZ   %.2f \n', fh);
fprintf(file, '#define LOW_PASS_FILTER_ORDER     %d \n\n', Lowpass_Order);
for x = 1:length(AL)
    fprintf(file, '#define F1_A%d   ((const double)%.16d)\n', x-1, AL(x));
end

fprintf(file, '\n');
for x = 1:length(BL)
    fprintf(file, '#define F1_B%d   ((const double)%.16d)\n', x-1, BL(x));
end

fprintf(file, '\nconst double A_low_pass [] = {');
for x = 1:(length(AL)-1)
    fprintf(file, 'F1_A%d, ', x-1);
end
fprintf(file, 'F1_A%d};',x);

fprintf(file, '\nconst double B_low_pass [] = {');
for x = 1:(length(BL)-1)
    fprintf(file, 'F1_B%d, ', x-1);
end
fprintf(file, 'F1_B%d};',x);

fprintf(file, '\nconst FilterParameters low_pass_filter_parameters = {LOW_PASS_FILTER_ORDER, A_low_pass, B_low_pass};');

fprintf(file, '\n\n/*****************************************************************************/\n');
fprintf(file, '\n#endif /* DSP_H_ */');
fclose(file);

disp('Done !')
```
From the previous given parameter, the script result is listed below as C code header file, DSP.H.

```C
/*****************************************************************************/
/**                                                                         **/
/** DSP.H                                                                   **/
/**                                                                         **/
/** Butterworth IIR filter design.                                          **/
/** This file was auto generated by a MATLAB script.                        **/
/**                                                                         **/
/** Created on: 16-Mar-2017                                                 **/
/**                                                                         **/
/** Author: Yarib Nevárez                                                   **/
/**         yarib_007@hotmail.com                                           **/
/**                                                                         **/
/*****************************************************************************/

#ifndef DSP_H_
#define DSP_H_
/*****************************************************************************/
#define DSP_SAMPLE_TIME           0.0010000000000000
/*****************************************************************************/

#define HIGH_PASS_CUTOFF_FREC_HZ  0.83 
#define HIGH_PASS_FILTER_ORDER    4 

#define F0_A0  ((const double)0000000000000001)
#define F0_A1  ((const double)-3.9863177122115889e+00)
#define F0_A2  ((const double)5.9590466614474735e+00)
#define F0_A3  ((const double)-3.9591398122141528e+00)
#define F0_A4  ((const double)9.8641086372476394e-01)

#define F0_B0  ((const double)9.9318219059987367e-01)
#define F0_B1  ((const double)-3.9727287623994947e+00)
#define F0_B2  ((const double)5.9590931435992420e+00)
#define F0_B3  ((const double)-3.9727287623994947e+00)
#define F0_B4  ((const double)9.9318219059987367e-01)

const double A_high_pass [] = {F0_A0, F0_A1, F0_A2, F0_A3, F0_A4};
const double B_high_pass [] = {F0_B0, F0_B1, F0_B2, F0_B3, F0_B4};
const FilterParameters high_pass_filter_parameters = {HIGH_PASS_FILTER_ORDER, A_high_pass, B_high_pass};

/*****************************************************************************/

#define LOW_PASS_CUTOFF_FREC_HZ   3.00 
#define LOW_PASS_FILTER_ORDER     6 

#define F1_A0   ((const double)0000000000000001)
#define F1_A1   ((const double)-5.9271711199548411e+00)
#define F1_A2   ((const double)1.4638502887108055e+01)
#define F1_A3   ((const double)-1.9282239468695700e+01)
#define F1_A4   ((const double)1.4287413214011815e+01)
#define F1_A5   ((const double)-5.6462639615981418e+00)
#define F1_A6   ((const double)9.2975844917206940e-01)

#define F1_B0   ((const double)6.7587602181617967e-13)
#define F1_B1   ((const double)4.0552561308970780e-12)
#define F1_B2   ((const double)1.0138140327242695e-11)
#define F1_B3   ((const double)1.3517520436323593e-11)
#define F1_B4   ((const double)1.0138140327242695e-11)
#define F1_B5   ((const double)4.0552561308970780e-12)
#define F1_B6   ((const double)6.7587602181617967e-13)

const double A_low_pass [] = {F1_A0, F1_A1, F1_A2, F1_A3, F1_A4, F1_A5, F1_A6};
const double B_low_pass [] = {F1_B0, F1_B1, F1_B2, F1_B3, F1_B4, F1_B5, F1_B6};
const FilterParameters low_pass_filter_parameters = {LOW_PASS_FILTER_ORDER, A_low_pass, B_low_pass};

/*****************************************************************************/

#endif /* DSP_H_ */
```

Once the header file is modified, it is detected by the SDK and it recompiles the target code for the ARM core. The symbols (variables and constants names) utilized in the header file are already employed in the POXI implementation, it is important to keep or maintain these symbols.
Finally, the following script takes the DSP library (firmware C language implementation) and generates the filter blocks for MATLAB Simulink.

```MATLAB
% create legacy mex function for cart control
clc

% High Pass Filter
specs_hpf = legacy_code('initialize');
specs_hpf.SourceFiles = {'MATLAB.C', 'filter.c'};
specs_hpf.SrcPaths={'..\poxi.sdk\poxi\src\dsp\'};
specs_hpf.HeaderFiles = {'MATLAB.H', 'filter.h'};
specs_hpf.IncPaths={'..\poxi.sdk\poxi\src\dsp\'};
specs_hpf.SFunctionName = 'High_Pass_Filter';
specs_hpf.OutputFcnSpec = 'double y1 = high_pass_filter_wrapper(double u1)';
legacy_code('sfcn_cmex_generate', specs_hpf)
legacy_code('compile', specs_hpf)
%legacy_code('slblock_generate', specs_hpf)  % Comment out this line


% LOw Pass Filter
specs_lpf = legacy_code('initialize');
specs_lpf.SourceFiles = {'MATLAB.C', 'filter.c'};
specs_lpf.SrcPaths={'..\poxi.sdk\poxi\src\dsp\'};
specs_lpf.HeaderFiles = {'MATLAB.H', 'filter.h'};
specs_lpf.IncPaths={'..\poxi.sdk\poxi\src\dsp\'};
specs_lpf.SFunctionName = 'Low_Pass_Filter';
specs_lpf.OutputFcnSpec = 'double y1 = low_pass_filter_wrapper(double u1)';
legacy_code('sfcn_cmex_generate', specs_lpf)
legacy_code('compile', specs_lpf)
%legacy_code('slblock_generate', specs_lpf) % Comment out this line

disp('Poxi filter C legacy... Done')
```

The next lines of code implement the filter instances contained in the legacy block.

```C
/*
 * MATLAB.C
 *
 *  Created on: 26 de ene. de 2017
 *      Author: Yarib Nevárez
 */
#include "filter.h"
#include "DSP.H"

double high_pass_filter_wrapper(double u1)
{
    static Filter * filter = (Filter *)0;

    if (filter == 0)
    {
        filter = Filter_new(&high_pass_filter_parameters);
    }

    return filter->process(filter, u1);
}

double low_pass_filter_wrapper(double u1)
{
    static Filter * filter = (Filter *)0;

    if (filter == 0)
    {
        filter = Filter_new(&low_pass_filter_parameters);
    }

    return filter->process(filter, u1);
}
```

The generated filter blocks are used in a simulation, the simulation has three independent filter blocks, continues time, discrete time, and legacy code. It displays the filter results of all these for comparison.

Best regards,

-Yarib Nevárez
